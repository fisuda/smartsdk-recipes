<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>HA - SmartSDK Recipes</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/highlight.css">
  <link href="https://fiware.org/style/fiware_readthedocs.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "HA";
    var mkdocs_page_input_path = "data-management/sth/ha/readme.md";
    var mkdocs_page_url = "/data-management/sth/ha/readme/";
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> SmartSDK Recipes</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../..">Home</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../../installation/">Installation</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Recipes</span></li>

        
            
    <ul class="subnav">
    <li><span>Data/Context Management</span></li>

        
            
    <ul class="subnav">
    <li><span>Context Broker</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../context-broker/readme/">Intro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../context-broker/simple/readme/">Simple</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../context-broker/ha/readme/">HA</a>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>STH</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../readme/">Intro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../standalone/readme/">Standalone</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">HA</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#ha">HA</a></li>
                
                    <li><a class="toctree-l4" href="#requirements">Requirements</a></li>
                
                    <li><a class="toctree-l4" href="#introduction">Introduction</a></li>
                
                    <li><a class="toctree-l4" href="#a-walkthrough">A walkthrough</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>Cygnus</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../cygnus/readme/">Intro</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../cygnus/ha/readme/">HA</a>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>QuantumLeap</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../quantumleap/readme/">Intro</a>
        
    </li>

        
    </ul>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>IoT Services Enablement</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../iot-services/readme/">IDAS</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../iot-services/iotagent-json/README/">IoT Agent JSON</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../iot-services/iotagent-lwm2m/readme/">IoT Agent LWM2M</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../iot-services/iotagent-ul/README/">IoT Agent UL</a>
        
    </li>

        
    </ul>

        
            
    <ul class="subnav">
    <li><span>Utils</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../../../utils/mongo-replicaset/readme/">MongoDB Replica Set</a>
        
    </li>

        
    </ul>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../../tools/readme/">Tools</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../../../contributing/">Contributing</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">SmartSDK Recipes</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Data/Context Management &raquo;</li>
        
      
        
          <li>STH &raquo;</li>
        
      
    
    <li>HA</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/smartsdk/smartsdk-recipes/edit/master/recipes/data-management/sth/ha/readme.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="ha">HA</h1>
<h2 id="requirements">Requirements</h2>
<p>Please make sure you read the <a href="../../../..">welcome page</a> and followed
the steps explained in the <a href="../../../../installation/">installation guide</a>.</p>
<h2 id="introduction">Introduction</h2>
<p>Let's test a deployment of Comet with multiple replicas in both its front-end
and backend. The idea now is to get the scenario illustrated below.</p>
<p><img src='http://g.gravizo.com/g?
digraph Cluster {
    label="Docker Swarm"
    rankdir=LR;
    compound=true;
    node [shape="record" style="filled" fillcolor=aliceblue];
    splines=line;
    "Client" [shape=oval];
    "NGSI";
    "Comet LB";
    Comet1;
    Comet2;
    Comet3;
    "Comet DB 1" [shape=egg];
    "Comet DB 2" [shape=egg];
    "Comet DB 3" [shape=egg];
    "NGSI" -> "Comet LB" [label="Notifications"];
    "Client" -&gt; "Comet LB" [label=8666];
    "Comet LB" -&gt; {Comet1,Comet2,Comet3};
    "Comet2" -&gt; "Comet DB 1";
    "Comet1" -&gt; "Comet DB 1";
    "Comet3" -&gt; "Comet DB 1";
    "Comet DB 1" -&gt; "Comet DB 2" [dir=both];
    "Comet DB 2" -&gt; "Comet DB 3" [dir=both];
    "Comet DB 1" -&gt; "Comet DB 3" [dir=both];
    {rank=same; "Comet DB 2"; "Comet DB 3"}
}
'&gt;</p>
<p>Later, this could be combined for example with an
<a href="../../../context-broker/ha/readme/">HA deployment of Orion Context Broker</a>.</p>
<h2 id="a-walkthrough">A walkthrough</h2>
<p>First, you need to have a Docker Swarm (docker &gt;= 1.13) already setup. If you
don't have one, checkout the <a href="../../../../tools/readme/">tools</a> section for
a quick way to setup a local swarm.</p>
<pre><code>    miniswarm start 3
    eval $(docker-machine env ms-manager0)
</code></pre>

<p>Comet needs a mongo database for its backend. If you have already deployed
Mongo within your cluster and would like to reuse that database, you can skip
the next step (deploying backend). You will just need to pay attention to
the variables you define for Comet to link to Mongo, namely,
<code>MONGO_SERVICE_URI</code> and <code>REPLICASET_NAME</code>. Make sure you have the correct
values in <code>frontend.env</code>. The value of <code>MONGO_SERVICE_URI</code> should be a routable
address for mongo. If deployed within the swarm, the service name (with stack
prefix) would suffice. You can read more in the
<a href="https://docs.docker.com/docker-cloud/apps/service-links/">official docker docs</a>.
The default values should be fine for you if you used the
<a href="../../../../utils/mongo-replicaset/readme/">Mongo Replicaset Recipe</a>.</p>
<p>Otherwise, if you prefer to make a new deployment of Mongo just for Comet, you
can take a shortcut and run...</p>
<pre><code>    sh deploy_back.sh
</code></pre>

<p>After a while, when the replica-set is ready, you can deploy comet by running...</p>
<pre><code>    sh deploy_front.sh
</code></pre>

<p>Now, as usual, a brief test to confirm everything is properly connected.
As a source of notifications, we have deployed Orion in the swarm (see
<a href="../../../context-broker/ha/readme/">Orion in HA</a> for example).</p>
<p>For convenience, let's save the IP address of the Orion and Comet services.
In this scenario, since both are deployed on Swarm exposing their services
ports, only one entry-point to the Swarm's ingress network will suffice.</p>
<pre><code>    ORION=http://$(docker-machine ip ms-manager0)
    COMET=http://$(docker-machine ip ms-manager0)
</code></pre>

<p>Insert:</p>
<pre><code>    sh ../../context-broker/insert.sh $ORION
    sh ../../context-broker/query.sh $ORION
    ...
</code></pre>

<p>Subscribe:</p>
<pre><code>    sh ../subscribe.sh $ORION
    {
      &quot;subscribeResponse&quot; : {
        &quot;subscriptionId&quot; : &quot;58bd1940b97cc713f5eacdb7&quot;,
        &quot;duration&quot; : &quot;PT24H&quot;
      }
    }
</code></pre>

<p>Update:</p>
<pre><code>    sh ../../context-broker/update.sh $ORION
</code></pre>

<p>And voila:</p>
<pre><code>    sh ../query_sth.sh $COMET
    {
    &quot;contextResponses&quot;: [
        {
            &quot;contextElement&quot;: {
                &quot;attributes&quot;: [
                    {
                        &quot;name&quot;: &quot;temperature&quot;,
                        &quot;values&quot;: [
                            {
                                &quot;attrType&quot;: &quot;Float&quot;,
                                &quot;attrValue&quot;: 23,
                                &quot;recvTime&quot;: &quot;2017-03-06T08:09:36.493Z&quot;
                            },
                            {
                                &quot;attrType&quot;: &quot;Float&quot;,
                                &quot;attrValue&quot;: 29.3,
                                &quot;recvTime&quot;: &quot;2017-03-06T08:11:14.044Z&quot;
                            }
                        ]
                    }
                ],
                &quot;id&quot;: &quot;Room1&quot;,
                &quot;isPattern&quot;: false,
                &quot;type&quot;: &quot;Room&quot;
            },
            &quot;statusCode&quot;: {
                &quot;code&quot;: &quot;200&quot;,
                &quot;reasonPhrase&quot;: &quot;OK&quot;
            }
        }
    ]
    }
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../cygnus/readme/" class="btn btn-neutral float-right" title="Intro">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../standalone/readme/" class="btn btn-neutral" title="Standalone"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/smartsdk/smartsdk-recipes" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../standalone/readme/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../../cygnus/readme/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../../../js/theme.js"></script>
      <script src="../../../../iot-services/iotagent-json/config.js"></script>
      <script src="../../../../iot-services/iotagent-lwm2m/config.js"></script>
      <script src="../../../../iot-services/iotagent-ul/config.js"></script>

</body>
</html>
